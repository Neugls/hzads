<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{.title}}</title>
  <meta name="description" content="A minimalist layout for Login pages. Built with Pico CSS.">
  <link rel="shortcut icon" href="/static/favicon.ico">
  <!-- Pico.css -->
  <link rel="stylesheet" href="/static/pico.min.css">
  <link rel="stylesheet" href="/static/common.css">
  <link rel="stylesheet" href="/static/datatables.min.css">
</head>

<body>

  <!-- Nav -->
  <nav class="container-fluid">
    <ul>
      <li><a href="./" class="contrast" onclick="event.preventDefault()"><strong>好智广告管理系统</strong></a></li>
    </ul>
    <ul class="actions">
      <li><a href="#add" class="contrast" data-theme-switcher="auto">增加广告</a></li>
      <li><a href="/admin/logout" class="contrast" data-theme-switcher="light">退出后台</a></li>
    </ul>
  </nav><!-- ./ Nav -->

  <!-- Main -->
  <main class="container">
    <article class="grid">
      <table>
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">广告名</th>
            <th scope="col">类型</th>
            <th scope="col">内容</th>
            <th scope="col">状态</th>
            <th scope="col">排序</th>
            <th scope="col">创建时间</th>
            <th scope="col">更新时间</th>
            <th scope="col">操作</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </article>
  </main><!-- ./ Main -->

  <dialog id="add-new-ads">
    <article>
      <a href="#close" aria-label="Close" class="close" data-target="modal-example">
      </a>
      <h3>添加广告</h3>
      <div>
        <div class="grid">

          <!-- Markup example 1: input is inside label -->
          <label for="name">
            广告名
            <input type="text" id="name" name="name" placeholder="广告名" required>
          </label>

          <label for="type">
            类型
            <select id="type" name="type" required>
              <option value="image" selected>图片</option>
              <option value="video">视频</option>
              <option value="webpage">网页</option>
            </select>
          </label>

        </div>
        <div class="grid">
          <label for="file">上传文件
            <input type="file" id="file" name="content">
          </label>
        </div>
      </div>
      <footer>
        <a href="#cancel" role="button" class="secondary" data-target="modal-example">
          取消
        </a>
        <a href="#confirm" role="button" data-target="modal-example">
          添加
        </a>
      </footer>
    </article>
  </dialog>

  <script src="/static/jquery-3.6.0.min.js"></script>
  <script src="/static/datatables.min.js"></script>
  <script type="text/javascript">
    $(document).ready(function () {
      $('table').DataTable({
        "ajax": '/admin/ads',
        "columns": [
          { "data": "id" },
          { "data": "name" },
          { "data": "type" },
          { "data": "content", render: function(data, type, row){
            if (row.type == 'image') {
              return '<img src="/' + data + '" width="100" height="100">';
            } else if (row.type == 'video') {
              return '<video src="/' + data + '" width="100" height="100"></video>';
            } else if (row.type == 'webpage') {
              return '<a href="' + data + '">' + data + '</a>';
            }
          }},
          { "data": "status", render: function(data, type, row){
            if(type === 'display' || type === 'filter') {
              if (data == 1) {
                return '已启用';
              }
              return '已禁用';
            }
            return data;
          }},
          { "data": "sort" },
          {
            "data": "created", render: function (data, type, row) {
              // If display or filter data is requested, format the date
              if (type === 'display' || type === 'filter') {
                var d = new Date(data * 1000);
                return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
              }

              // Otherwise the data type requested (`type`) is type detection or
              // sorting data, for which we want to use the integer, so just return
              // that, unaltered
              return data;
            }
          },
          { "data": "updated", render: function (data, type, row) {
              // If display or filter data is requested, format the date
              if (type === 'display' || type === 'filter') {
                var d = new Date(data * 1000);
                return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
              }

              // Otherwise the data type requested (`type`) is type detection or
              // sorting data, for which we want to use the integer, so just return
              // that, unaltered
              return data;
            } },
          { "data": null, render:function(data, type, row){
            if(type === 'display'){
              let r = "";
              if (row.status == 0 ) {
                r += '<a aid="'+row.id+'" href="#valid" class="contrast" >启用</a>';
              } else {
                r += '<a aid="'+row.id+'" href="#invalid" class="button contrast">弃用</a>'
              }
              r += '| <a aid="'+row.id+'" href="#del" class="button contrast">删除</a>'
              return r; 
            }
            return data;
          }} 
        
        ]
      });
      $('table').on("click", "a[href='#invalid']", function(e){
        e.preventDefault();
        var aid = $(this).attr('aid');
        $.ajax({
          url: '/admin/ad/' + aid,
          type: 'POST',
          data: {
            action: 'invalid'
          },
          success: function(data){
            if(data.status == "ok"){
              alert('操作成功');
              $('table').DataTable().ajax.reload();
            }else{
              alert(data.msg);
            }
          }
        });
      });
      $('table').on("click", "a[href='#del']", function(e){
        e.preventDefault();
        var aid = $(this).attr('aid');
        $.ajax({
          url: '/admin/ad/' + aid,
          type: 'POST',
          data:{
            action: 'del'
          },
          success: function(data){
            if(data.status == "ok"){
              alert('操作成功');
              $('table').DataTable().ajax.reload();
            }else{
              alert(data.msg);
            }
          }
        });
      }).on("click", "a[href='#valid']", function(e){
        e.preventDefault();
        var aid = $(this).attr('aid');
        $.ajax({
          url: '/admin/ad/' + aid,
          type: 'POST',
          data:{
            action: 'valid'
          },
          success: function(data){
            if(data.status == "ok"){
              alert('操作成功');
              $('table').DataTable().ajax.reload();
            }else{
              alert(data.msg);
            }
          }
        });
      });

      $(".actions").on("click", "a[href='#add']", function (e) {
        e.preventDefault();
        $("#add-new-ads").attr("open", "open");
      });


      $("#add-new-ads").on("click", "a[href='#confirm']", function (e) {
        e.preventDefault();
        var name = $("#name").val();
        var type = $("#type").val();
        var file = $("#file")[0];
        var self = $(this);

        var formData = new FormData();
        formData.append("name", name);
        formData.append("type", type);
        formData.append("content", file.files[0]);

        self.attr("disabled", "disabled").attr("aria-busy", "true");


        $.ajax({
          url: '/admin/ads',
          type: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          success: function (data) {
            if (data.status == "ok") {
              alert("添加成功");
              $("#add-new-ads").removeAttr("open");
              $("#name").val("");
              $("#type").val("");
              $("#file").val(null)
              $('table').DataTable().ajax.reload();
              self.removeAttr("disabled").removeAttr("aria-busy");
            } else {
              alert(data.msg);
              self.removeAttr("disabled").removeAttr("aria-busy");
            }
          },
          error: function (data) {
            alert("添加失败" + data);
            self.removeAttr("disabled").removeAttr("aria-busy");
          }
        });
      }).on("click", "a[href='#cancel']", function (e) {
        e.preventDefault();
        $("#add-new-ads").removeAttr("open");
      }).on("click", "a[href='#close']", function (e) {
        e.preventDefault();
        $("#add-new-ads").removeAttr("open");
      });
    });
  </script>
</body>

</html>